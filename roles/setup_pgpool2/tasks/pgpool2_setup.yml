---
# Generate configuration parameters dictionary
- name: Generate configuration parameters dictionary
  set_fact:
    config_dict: >-
      {{ config_dict|default({}) | combine( {ci.key: ci.value} ) }}
  with_items: "{{ pgpool2_configuration }}"
  loop_control:
    loop_var: ci
  when:
    - ci.state == 'present'

- name: Create pgpoolII system group {{ pgpool2_group }}
  group:
    name: "{{ pgpool2_group }}"
    state: present
  delegate_to: "{{ item.value.public_ip }}"

- name: Create pgpoolII system user {{ pgpool2_user }}
  user:
    name: "{{ pgpool2_user }}"
    system: true
    group: "{{ pgpool2_group }}"
    state: present
    create_home: false
  delegate_to: "{{ item.value.public_ip }}"

# Build the configuration file
- include_role:
    name: manage_pgpool2
    tasks_from: pgpool2_manage_configuration
  with_dict:  "{{ servers }}"
